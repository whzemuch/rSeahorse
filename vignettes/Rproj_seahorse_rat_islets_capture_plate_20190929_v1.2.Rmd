---
title: "seahorse_islet capture plate"
author: "whzemuch"
date: "9/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(janitor)
library(ggsci)
library(ggpubr)
library(cowplot)
library(ggstatsplot) 
library(rstatix)
library(export)

```

## Description:
 
  - data: read from workbook "Rate Data"
  - event: read from workbook "Time Event"
  - data_min: transform the datetime to the minutes
  - data_mito: Calculation for different types of respiration
  - event_label: for A, B, C, D near the vertical line: annotation
  - well_label: for well name used in the quick viewing: geom_text
  
  - data_seahorse: 
      "data", "data_min", "event_label", "well_label",  "sheet_names"
  
  - well_exclude: list of outliers after quick viewing
  - bin_list: convert numerical minute column to categorical section column 
  
## Work flow

  1. Import data
  2. Clean and transfrom data
  3. Create a list of wells that need to be excluded after quick reviewing
  4. Plotting the main chart for the seahorse analysis.
  5. 
  
## main function
 - load_seahorse: 
     input: *.xls, group_info 
     output: list(data, data_min, event_label, well_label, sheet_names )
     
 - qview_seahorse: 
     input: data_min, well_label
     output: ggplot object
     
 - plot_seahorse: 
     input(data_min, well_exclude, group_info, size_group)
     output: ggpplot object
     
## Code 

```{r, setup the theme}
# ggplot theme for publication ready Plots by Koundinya Desiraju
# https://rpubs.com/Koundy/71792

theme_Publication <- function(base_size=12, base_family="") {
      library(grid)
      library(ggthemes)
      (theme_foundation(base_size=base_size, base_family=base_family)
       + theme(plot.title = element_text(face = "bold",
                                         size = rel(1.2), hjust = 0.5),
               plot.background = element_rect(colour = NA),
               text = element_text(),
               
               
               panel.background = element_rect(colour = NA),
               #panel.grid.major = element_line(colour="#f0f0f0"),
               panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(),
               
               #panel.border = element_rect(colour = NA),
               
               
               axis.title = element_text(face = "bold",size = rel(1)),
               axis.title.y = element_text(angle=90,vjust =2),
               axis.title.x = element_text(vjust = -0.2),
               axis.text = element_text(), 
               axis.line = element_line(colour="black"),
               axis.ticks = element_line(),
               
               
               legend.key = element_rect(colour = NA),
               #legend.position = "bottom",
               # legend.direction = "horizontal",
               # legend.key.size= unit(0.2, "cm"),
               # legend.margin = unit(0, "cm"),
               # legend.title = element_text(face="italic"),
               #legend.position = "none", 
               
               plot.margin=unit(c(10,5,5,5),"mm"),
               
               #strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
               strip.text = element_text(face="bold"),
               strip.background = element_rect(fill="white"),
               #strip.text.x = element_text(face="bold"),
               #strip.text.y = element_text(face="bold"),
                
          ))
      
}

scale_fill_Publication <- function(...){
      library(scales)
      discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

scale_colour_Publication <- function(...){
      library(scales)
      discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

```


```{r, seahorse analysis}
#qview_seahorse()
# 1. Get group information======================
Group_Info <- tibble(
                     Well = factor(1:24), 
                     Group = rep(c("X", "Y", "Z", "F"), each = 6),
                     Col = paste0("C",rep(1:6, 4 )),
                     Row = paste0("R", rep(1:4, each=6)),
                     Treatment =  rep(c("ECMplus", "BM-ECM", "TCP", "Fresh"), each = 6)
                    ) %>% 
  mutate(
         Group = factor(Group, levels= c("F", "Z", "X", "Y"),
                                labels=c("Fresh", "TCP", "ECMplus", "BM-ECM" ))
        )


# 2. Import data ===========================
file <- "./data/XFAssay_9282020_1149.xls"

load_seahorse <- function(file=file, group_info=Group_Info) {
   # file: the full name of xls file with the path
   # group_information: "Well", "Group"
  
  # list the sheet names
    sheet_names <- excel_sheets(file)
  # ROS data
    rate_data <- read_excel(file, sheet = "Rate Data", skip = 7)
  #  Time for A, B, C, D
    event <- read_excel(file, sheet = "Time Events", skip =4)
    
  # jOIN the group information to the data
   data <- rate_data %>% 
     select(4,5,7) %>%
     mutate(Well = factor(Well)) %>% 
     left_join(Group_Info, by="Well") %>% 
     mutate(OCR = `OCR (pMoles/min)`)
   
   # convert time to minutes 
     start_time <-  min(data$Time) 
     data_min <- data %>% 
       group_by(Group) %>% 
       mutate(minute = difftime(Time, start_time, units = "mins") %>% 
                       as.numeric %>% 
                       floor()
              ) %>% 
        ungroup() 


    # construct data for labeling the vertical lines
      event_label <- event %>% 
        filter(Event == "Injecting") %>% 
        filter(str_detect(Time, '1')) %>%  
        mutate(Time = convert_to_datetime(Time)) %>% 
        mutate(minute = difftime(Time, start_time, units = "mins") %>%
                 as.numeric %>% 
                 floor()
               ) %>% 
        mutate(treatment = c("Glucose", "Oligomycin", "FCCP", "Rote_AA"), y=Inf) %>% 
        ungroup() #%>% View


        # construct data for labeling samples with the well name
       well_label <-  data %>% 
         group_by(Group, Col, Row, Well) %>% 
           summarise(n=n()) %>% 
            mutate(x=Inf, y=Inf) %>% 
            select(-n) 
      
    return (list(data = data,
                 data_min = data_min,
                 event_label = event_label,
                 well_label = well_label,
                 sheet_names = sheet_names
                 
                 )
            )
  
}

data_seahorse <- load_seahorse(file, Group_Info)



  
# 3. Qucik view============================================

qview_seahorse <- function(list=data_seahorse) {
  # df: data_seahorse
  
  # check if two dataframes exist
  df_exist <- sum(names(list) %in% c("data_min", "well_label")) == 2
  if (df_exist) {
    data_min = df$data_min
    well_label = df$well_label
  } else{
    stop("The datafrmaes(data_min, well_label) don't exsit!")
  }
  

   
  
  
  #filter(!(Well %in% c("6", "9", "11", "15", "18"))) %>% 
  p <- ggplot(data=data_min, aes(minute, OCR, color=Row)) +
    geom_point() +
    geom_smooth(method = "gam", size = 1) +
    geom_text(data = well_label, aes(x=x, y=y, label=Well), hjust=1.2, vjust=1.5) +
    geom_text(data = well_label, aes(x=x, y=y, label=Group), hjust=1, vjust=2.8) +
    facet_grid(Row ~ Col) +
    ggtitle("Quick View of Seahorse  Data") +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold",
                                size = rel(1.2), 
                                hjust = 0.5),
      axis.title = element_text(face = "bold",size = rel(1)),
      
      legend.position = "none"
    )
  
   return(p)

}


qview <- qview_seahorse(df=data_seahorse)

qview


# 4. Plotting ==================================


wells_exclude <- c("6", "9", "11", "15", "18", "20", "23" )

plot_seahorse <- function(list=data_seahorse, wells_exclude=wells_exclude, group_info=Group_Info, size_group) {
  # df: data_min
  # wells_exclude: a vector
  # group_info: a named vector, name is the labels, value is the levels
  # size_group: for calculation SEM
  
  event_label = list$event_label
  data_min = list$data_min
  
  p1 <- data_min %>%
  # filter unwanted samples
  filter(!(Well %in% wells_exclude)) %>%
  #filter(Group != "Y") %>% 
  
  # calculate the mean and se for OCR in each group
  group_by(Group, minute) %>% 
  summarize(AVG_OCR = mean(OCR), 
            SD = sd(OCR)/sqrt(size_group), 
            .groups="drop") %>% 
   
  # draw a ggplot with point and line
  ggplot(aes(x=minute, y=AVG_OCR, color=Group,  shape=Group)) +
  geom_point() +
  geom_line() +
  #geom_smooth(method = "gam", size = 1, span=0.9) +
   
  # add error bar
  geom_errorbar(aes(ymin=AVG_OCR - SD, ymax=AVG_OCR + SD), width = .8, position = position_dodge(.05))+ 
 
  
  # add the vertical lines
  geom_vline(data = event_label, aes(xintercept=minute),color="grey40", linetype="longdash", lwd=0.5 ) +
  
  # Change title and x, ylabs
  labs(
    title = "Seahorse Analysis of rat islets cultured on TCP VS ECMplus",
    x = "Minutes",
    y = "OCR (pMoles/min)"
    ) + 
  theme_bw()
  
# add annotation text 
p2 <- p1 + annotate("text", x=event_label$minute, y=Inf, label= event_label$Parameter, hjust=1.2, vjust=1.5) + 
    theme_Publication() 

 return(p2)

  
  
}

tibble()
data_seahorse$data_min <- data_seahorse$data_min %>% 
 filter(Treatment != "BM-ECM") 
   
p_seahorse <- data_seahorse %>% 
  plot_seahorse( wells_exclude, Group_Info, 6)

p_seahorse


# 5. Export the chart to a ppt file===================


export::graph2ppt(p_seahorse, file="Seahorse_analysis_rat_iselts_2020Oct.pptx", width=8, height=6, append=TRUE)


```

```{r, transforming data into percentage}

data_min_percent <- data_min %>% 
  select(Group, Well, Col, OCR, minute) %>% 
  pivot_wider( names_prefix = "mins_",
              names_from = minute,
              values_from = OCR) %>% 
  mutate(across(starts_with("mins_"), ~ 100 *./mins_18)) %>% #View
  pivot_longer(cols = starts_with("mins_"),
               names_to = "minute",
               values_to = "OCR",
               names_prefix = "mins_"
               ) %>% 
  mutate(minute = as.numeric(minute))
  

```


```{r, calculation mitochondria related values}



min_bin <- event_label %>% 
  pull(minute, treatment) %>% View

make_time_bin <- function(list = data_seahorse) {
  event_label <- list$event_label
  bin_list <-  list(
          breaks = c(-Inf, event_label$minute, Inf),
          treatment = c("Base", event_label$treatment),
          labels = c("Base", event_label$Parameter)
          )
 }
bin_list <- make_time_bin(data_seahorse)

Calculate_OCR_subtype <- function(list=data_seahorse, bin_list=bin_list) {
  
  # get the last time point for each section
  data_min <- list$data_min
  
  last_timepoint <- data_min %>% 
  filter(!(Well %in%  wells_exclude)) %>%
  mutate(section = cut(minute, breaks = bin_list$breaks, labels=bin_list$labels)) %>%  
  select(section, minute) %>% 
  group_by(section) %>% 
  filter(row_number() > n()-1) %>% 
  pull(minute, section) #%>% View
  
  
  data_mito <-  data_min %>% 
  filter(!(Well %in%  wells_exclude)) %>%
    
  group_by(Well) %>% 
  select(Well, Group, minute, OCR) %>% 
  mutate(section = cut(minute, breaks = bin_list$breaks, labels=bin_list$labels)) %>%
  pivot_wider(
    names_from=c("section","minute"),
    values_from = "OCR"
  ) %>% 
  
  rowwise() %>% 
  mutate(
    max_a = max(c_across(starts_with("A"))),
    min_b = min(c_across(starts_with("B"))),
    max_c = max(c_across(starts_with("C"))),
    min_d = max(c_across(starts_with("D")))
    ) %>% 
    
  select(1:2, num_range("Base_", last_timepoint[["Base"]]), starts_with("min"), starts_with("max")) %>% 
  rename(Base_Resp = 3) %>% 
         
    mutate(
    #mito = if_else((A_18-min_c) < 0, 0, A_18-min_c)
    mito_Base_Respiration = Base_Resp - min_d,
    mito_Proton_Leak = min_b - min_d,
    mito_ATP_Production = Base_Resp - min_b,
    mito_Max_Respiration = max_c - min_d,
    mito_Non_Mito_Oxygen_Consumption = min_d,
    mito_Spare_Respiratory_Capacity = mito_Max_Respiration -  mito_Base_Respiration
    ) %>% 
    
  mutate(across(contains("mito"), ~if_else(.x < 0, 0, .x))) %>% 
  filter(Group != "Y") %>% 
  select(Well, Group, contains("mito")) %>% 
  pivot_longer(
    cols= starts_with("mito_"),
    names_to = "OCR_Type",
    names_prefix = "mito_",
    values_to = "OCR"
  )
  # %>% 
  # mutate(Group = factor(Group, levels=c("F", "Z", "X"), labels=c("Fresh", "TCP","ECMplus"))) %>% 
  # mutate(OCR_Type= factor(OCR_Type, 
  #        levels = c("Max_Respiration", "Base_Respiration", "ATP_Production",
  #                    "Proton_Leak", "Spare_Respiratory_Capacity","Non_Mito_Oxygen_Consumption"))
  #        )
         
# print(data_mito)

p_mito <- data_mito %>% 
  ggplot(aes(x=Group, y=OCR, fill=Group )) + 
    geom_boxplot(width= 0.5) +
    geom_jitter(width=0.2) +
    facet_wrap( ~ OCR_Type, scales = "free")+
    labs(x="", y="OCR(pmol/min)")+
    theme_Publication() +
    theme(
      strip.background = element_blank(),
      legend.position="none") 
  
p_mito
  
}
  
Calculate_OCR_subtype(data_seahorse)


  
data_seahorse$data_min %>% 
  filter(!(Well %in%  wells_exclude)) %>%
  mutate(section = cut(minute, breaks = bin_list$breaks, labels=bin_list$labels)) %>%  
  
  group_by(Well, Group, Col, section) %>% 
  summarise(min=min(OCR), max=max(OCR)) %>%
  pivot_wider(
    names_from = "section",
    values_from = c("min", "max")
  ) %>% View

# get the last measurement of 
data_seahorse$data_min %>% 
  filter(!(Well %in%  wells_exclude)) %>%
  mutate(section = cut(minute, breaks = bin_list$breaks, labels=bin_list$labels)) %>% 
  filter(section == "Base") %>% 
  group_by(Well) %>% 
  filter(row_number() > n()-1) %>% View 
  # top_n(1, row_number()) %>% View

 



graph2ppt(p_mito, width=8, height=6, file="calculation of different OCR.pptx")

# calculate p value for stat_pvalue_manual
if (T) {

stat_test <- data_mito %>% 
  filter(Well != "19") %>% 
  filter(Group != "F") %>% 
  
  group_by(OCR_Type) %>% 
  t_test(OCR ~ Group) %>% 
  adjust_pvalue(method="bonferroni") %>% 
  add_significance() %>% 
  add_xy_position(x="Group") 

stat_test

}

# ggpubr + stat_pvalue_manual
if (T) {
  

p_mito_pubr <- data_mito %>% 
  filter(Well != "19") %>%
  mutate(Group = factor(Group, levels=c("F", "Z", "X"), labels=c("Fresh", "TCP","ECMplus"))) %>% 
  mutate(OCR_Type= factor(OCR_Type, 
         levels = c("Max_Respiration", "Base_Respiration", "ATP_Production",
                     "Proton_Leak", "Spare_Respiratory_Capacity","Non_Mito_Oxygen_Consumption"))
  )%>% 
  
  ggbarplot(x="Group", y="OCR",
            add = "mean_sd", 
            facet.by = "OCR_Type"
           )

p_mito_pubr + stat_pvalue_manual(stat_test)

}





data_mito %>% 
  ggbetweenstats(x=Group, y=OCR)
  
save(data, data_mito, data_min, event, event_label, Group_Info, p2, p4, p_mito, file="seahorse.Rdata")

load(file="searhorse.Rdata")

plot_ggbetweens <- function(data) {
  
  data %>%
    ggbetweenstats(
    x=Group, 
    y=OCR,
    pairwise.comparisons = FALSE,
    ggsignif.args = list(textsize = 4, tip_length = 0.01))
    
}  
 
tx <- data_mito %>% 
  mutate(Type=OCR_Type) %>% 
  group_by(OCR_Type) %>% 
  nest() %>% 
  mutate(plots = map(data, plot_ggbetweens))

tx_p <- lapply(1:6, function(x){tx$plots[[x]] + ggtitle(tx$OCR_Type[[x]])} )
  
  
  ggbetweenstats(
    x=Group, 
    y=OCR,
    pairwise.comparisons = FALSE,
    ggsignif.args = list(textsize = 4, tip_length = 0.01))
                

if (F) {
  
 p3 <- data_min_percent %>%
  # filter unwanted samples
  filter(!(Well %in% c("6", "9", "11", "15" ))) %>%
  filter(Group != "Y") %>% 
  
  # calculate the mean and se for OCR in each group
  group_by(Group, minute) %>% 
  summarize(AVG_OCR = mean(OCR), 
            SD = sd(OCR)/sqrt(6), 
            Group = factor(Group, levels= c("F", "Z", "X", "Y"),
                           labels=c("Fresh", "TCP", "ECMplus", "BM-ECM" )),
            .groups="drop") %>% 
   
  # draw a ggplot with point and line
  ggplot(aes(x=minute, y=AVG_OCR, color=Group,  shape=Group)) +
  geom_point() +
  geom_line() +
  #geom_smooth(method = "gam", size = 1, span=0.9) +
   
  # add error bar
  geom_errorbar(aes(ymin=AVG_OCR - SD, ymax=AVG_OCR + SD), width = .8, position = position_dodge(.05))+ 
 
  
  # add the vertical lines
  geom_vline(data = event_label, aes(xintercept=minute),color="grey40", linetype="longdash", lwd=0.5 ) +
  
  # Change title and x, ylabs
  labs(
    title = "Seahorse Analysis of rat islets cultured on TCP VS ECMplus",
    x = "Minutes",
    y = "OCR (pMoles/min)"
    ) + 
  theme_bw()
  
# add annotation text 
p4 <- p3 + annotate("text", x=event_label$minute, y=Inf, label= event_label$Parameter, hjust=1.2, vjust=1.5) + 
    theme_Publication() 

p4

}


```


